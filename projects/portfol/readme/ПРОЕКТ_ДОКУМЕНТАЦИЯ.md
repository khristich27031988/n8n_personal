# Документация проекта автоматизации аналитики бизнеса

## Содержание

1. [Обзор проекта](#обзор-проекта)
2. [Структура проекта](#структура-проекта)
3. [Рабочие процессы n8n](#рабочие-процессы-n8n)
4. [Streamlit-приложение](#streamlit-приложение)
5. [Настройка и запуск](#настройка-и-запуск)
6. [Руководство по использованию](#руководство-по-использованию)
7. [Расширение функциональности](#расширение-функциональности)
8. [Развертывание для клиентов](#развертывание-для-клиентов)
9. [Устранение неполадок](#устранение-неполадок)

## Обзор проекта

Проект представляет собой систему автоматизации аналитики бизнес-данных с использованием n8n, Streamlit и LLM (Qwen API). Система позволяет:

- Загружать и анализировать CSV файлы с данными
- Автоматически генерировать рекомендации по обработке данных на основе анализа LLM
- Применять трансформации к данным
- Сохранять обработанные данные в базу данных SQLite
- Визуализировать данные с помощью Streamlit
- Получать бизнес-инсайты и рекомендации на основе данных
- Задавать вопросы к данным в формате чата

Основная идея проекта - максимальное использование возможностей n8n для автоматизации процессов анализа данных, с минимальным количеством кода на сервере.

## Структура проекта

```
/portfol/
├── data/                   # Директория для хранения данных
│   ├── raw/                # Исходные CSV файлы
│   ├── analyzed/           # Результаты анализа LLM
│   ├── processed/          # Обработанные данные
│   └── insights/           # Сгенерированные инсайты
├── n8n_workflows/          # Рабочие процессы n8n
│   ├── csv_analyzer.json   # Процесс анализа CSV
│   ├── data_transformer.json # Процесс трансформации данных
│   └── insights_generator.json # Процесс генерации инсайтов
├── streamlit_app/          # Приложение Streamlit
│   └── app.py              # Основное приложение
├── ИНСТРУКЦИЯ.md           # Инструкция по запуску проекта
└── ПРОЕКТ_ДОКУМЕНТАЦИЯ.md  # Данная документация
```

## Рабочие процессы n8n

### 1. CSV Analyzer (`csv_analyzer.json`)

**Назначение**: Анализ CSV-файлов и получение рекомендаций от LLM.

**Входные данные**:
- CSV-файл (через webhook)

**Выходные данные**:
- Анализ структуры файла
- Типы данных для каждого столбца
- Потенциальные проблемы с данными
- Рекомендуемые трансформации
- Предложения по визуализации
- Потенциальные бизнес-инсайты

**Узлы рабочего процесса**:
1. **Webhook** - Точка входа для загрузки файла
2. **Parse CSV** - Обработка CSV-файла и извлечение структуры
3. **Prepare LLM Prompt** - Подготовка запроса для LLM
4. **LLM API Request** - Отправка запроса в Qwen API
5. **Process LLM Response** - Обработка ответа от LLM
6. **Save Analysis** - Сохранение результатов анализа
7. **Respond to Webhook** - Возврат результатов

### 2. Data Transformer (`data_transformer.json`)

**Назначение**: Применение трансформаций к данным на основе результатов анализа.

**Входные данные**:
- ID файла
- Список трансформаций для применения

**Выходные данные**:
- Трансформированные данные в формате CSV
- Таблица в базе данных SQLite с обработанными данными

**Узлы рабочего процесса**:
1. **Webhook** - Точка входа для запуска трансформации
2. **Validate Input** - Проверка входных параметров
3. **Read Analysis File** - Чтение файла с результатами анализа
4. **Process Analysis** - Обработка результатов анализа
5. **Read Original CSV** - Чтение исходного CSV-файла
6. **Apply Transformations** - Применение трансформаций к данным
7. **Save Transformed CSV** - Сохранение трансформированных данных
8. **Prepare SQLite Queries** - Подготовка SQL-запросов
9. **Create Table** - Создание таблицы в SQLite
10. **Insert Data** - Вставка данных в таблицу
11. **Respond to Webhook** - Возврат результатов

### 3. Insights Generator (`insights_generator.json`)

**Назначение**: Генерация бизнес-инсайтов на основе данных.

**Входные данные**:
- ID файла или имя таблицы
- Вопрос пользователя (опционально)

**Выходные данные**:
- Ответ на вопрос пользователя
- Ключевые инсайты из данных
- Рекомендации по визуализации
- Потенциальные бизнес-решения

**Узлы рабочего процесса**:
1. **Webhook** - Точка входа для запроса инсайтов
2. **Prepare Queries** - Подготовка SQL-запросов
3. **Get Table Structure** - Получение структуры таблицы
4. **Get Table Data** - Получение данных из таблицы
5. **Prepare LLM Prompt** - Подготовка запроса для LLM
6. **LLM API Request** - Отправка запроса в Qwen API
7. **Process LLM Response** - Обработка ответа от LLM
8. **Save Insights** - Сохранение результатов анализа
9. **Prepare Visualization Data** - Подготовка данных для визуализации
10. **Respond to Webhook** - Возврат результатов

## Streamlit-приложение

Streamlit-приложение (`app.py`) предоставляет пользовательский интерфейс для взаимодействия с рабочими процессами n8n. Оно включает следующие функции:

1. **Загрузка данных**:
   - Загрузка CSV-файлов
   - Отправка файлов в n8n для анализа
   - Отображение результатов анализа
   - Выбор и применение трансформаций

2. **Чат с данными**:
   - Выбор таблицы для анализа
   - Задание вопросов к данным
   - Отображение ответов и инсайтов

3. **Просмотр файлов**:
   - Просмотр файлов в директориях проекта
   - Отображение содержимого CSV и JSON файлов

## Настройка и запуск

### Предварительные требования

1. **Docker** и **Docker Compose** для запуска n8n
2. **Python 3.8** или выше для запуска Streamlit
3. **API ключ для Qwen** или другой LLM-модели

### Настройка n8n

1. **Запуск n8n**:
   ```bash
   docker run -it --rm \
     --name n8n \
     -p 5678:5678 \
     -v ~/.n8n:/home/node/.n8n \
     n8nio/n8n
   ```

2. **Импорт рабочих процессов**:
   - Откройте интерфейс n8n по адресу `http://localhost:5678`
   - Перейдите в раздел "Workflows"
   - Нажмите "Import from File" и выберите файлы из директории `/portfol/n8n_workflows/`

3. **Настройка учетных данных**:
   - Создайте учетные данные для HTTP Header Auth с именем "Qwen API" и добавьте заголовок `Authorization: Bearer YOUR_API_KEY`
   - Создайте учетные данные для SQLite с именем "SQLite" и укажите путь к базе данных `/portfol/db/business_data.db`

4. **Активация рабочих процессов**:
   - Активируйте каждый рабочий процесс, нажав кнопку "Active" в интерфейсе n8n
   - Запишите URL вебхуков для использования в Streamlit-приложении

### Настройка Streamlit

1. **Установка зависимостей**:
   ```bash
   pip install streamlit pandas requests
   ```

2. **Настройка переменных окружения**:
   ```bash
   export N8N_BASE_URL="http://localhost:5678"
   ```

3. **Запуск приложения**:
   ```bash
   streamlit run /portfol/streamlit_app/app.py
   ```

## Руководство по использованию

### Анализ данных

1. Откройте Streamlit-приложение по адресу `http://localhost:8501`
2. Перейдите на страницу "Загрузка данных"
3. Загрузите CSV-файл
4. Нажмите кнопку "Анализировать файл"
5. После завершения анализа вы увидите:
   - Типы данных для каждого столбца
   - Потенциальные проблемы с данными
   - Рекомендуемые трансформации
   - Предложения по визуализации
   - Инсайты

### Трансформация данных

1. На странице с результатами анализа выберите трансформации, которые хотите применить
2. Нажмите кнопку "Применить выбранные трансформации"
3. После завершения трансформации вы увидите:
   - Ссылку на скачивание трансформированных данных
   - Информацию о созданной таблице в базе данных
   - Кнопку для получения инсайтов

### Получение инсайтов

1. На странице с результатами трансформации нажмите кнопку "Получить инсайты"
2. Или перейдите на страницу "Чат с данными", выберите таблицу и задайте вопрос
3. После генерации инсайтов вы увидите:
   - Ответ на ваш вопрос
   - Ключевые инсайты из данных
   - Рекомендации по визуализации
   - Потенциальные бизнес-решения

## Расширение функциональности

### Добавление новых трансформаций

Для добавления новых типов трансформаций:

1. Откройте файл `data_transformer.json`
2. Найдите функцию `applyTransformation` в узле "Apply Transformations"
3. Добавьте новый case в switch-statement для нового типа трансформации
4. Импортируйте обновленный рабочий процесс в n8n

### Интеграция с другими LLM

Для использования другой LLM-модели вместо Qwen:

1. Откройте файлы рабочих процессов (`csv_analyzer.json`, `insights_generator.json`)
2. Найдите узел "LLM API Request"
3. Измените URL и параметры запроса в соответствии с API выбранной модели
4. Обновите обработку ответа в узле "Process LLM Response"
5. Импортируйте обновленные рабочие процессы в n8n

### Добавление новых визуализаций

Для добавления новых типов визуализаций:

1. Откройте файл `app.py`
2. Найдите функцию `display_insights`
3. Добавьте код для создания новых типов визуализаций с использованием библиотек Streamlit (например, st.plotly_chart, st.altair_chart)

## Развертывание для клиентов

### Подготовка к развертыванию

1. **Создание Docker Compose файла**:
   ```yaml
   version: '3'
   services:
     n8n:
       image: n8nio/n8n
       ports:
         - "5678:5678"
       volumes:
         - ./n8n_data:/home/node/.n8n
       environment:
         - N8N_ENCRYPTION_KEY=your-encryption-key
         - N8N_PORT=5678
         - N8N_PROTOCOL=http
         - N8N_HOST=localhost
       restart: always
     
     streamlit:
       build:
         context: ./
         dockerfile: ./docker/streamlit/Dockerfile
       ports:
         - "8501:8501"
       volumes:
         - ./data:/app/data
         - ./db:/app/db
       environment:
         - N8N_BASE_URL=http://n8n:5678
       depends_on:
         - n8n
       restart: always
   ```

2. **Создание Dockerfile для Streamlit**:
   ```dockerfile
   FROM python:3.9-slim
   
   WORKDIR /app
   
   COPY requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   
   COPY streamlit_app/ /app/streamlit_app/
   
   EXPOSE 8501
   
   CMD ["streamlit", "run", "streamlit_app/app.py"]
   ```

3. **Создание файла requirements.txt**:
   ```
   streamlit==1.22.0
   pandas==1.5.3
   requests==2.28.2
   ```

### Процесс развертывания

1. **Подготовка сервера**:
   - Установите Docker и Docker Compose
   - Создайте директорию для проекта

2. **Копирование файлов проекта**:
   - Скопируйте структуру директорий и файлы проекта на сервер
   - Убедитесь, что все необходимые директории созданы

3. **Настройка переменных окружения**:
   - Создайте файл `.env` с необходимыми переменными окружения
   - Укажите API ключ для Qwen

4. **Запуск контейнеров**:
   ```bash
   docker-compose up -d
   ```

5. **Импорт рабочих процессов n8n**:
   - Откройте интерфейс n8n по адресу `http://your-server:5678`
   - Импортируйте рабочие процессы из директории `/portfol/n8n_workflows/`
   - Настройте учетные данные и активируйте рабочие процессы

6. **Проверка работоспособности**:
   - Откройте Streamlit-приложение по адресу `http://your-server:8501`
   - Проверьте все функции приложения

### Настройка для клиента

1. **Брендирование**:
   - Обновите заголовки и описания в Streamlit-приложении
   - Добавьте логотип клиента

2. **Настройка доступа**:
   - Настройте аутентификацию для n8n и Streamlit
   - Ограничьте доступ к API и базе данных

3. **Документация для клиента**:
   - Создайте руководство пользователя
   - Подготовьте обучающие материалы

## Устранение неполадок

### Проблемы с n8n

1. **Webhook не работает**:
   - Проверьте, активирован ли рабочий процесс
   - Убедитесь, что URL вебхука доступен извне
   - Проверьте логи n8n

2. **Ошибка при выполнении рабочего процесса**:
   - Проверьте учетные данные для API и базы данных
   - Убедитесь, что все необходимые директории существуют и доступны для записи
   - Проверьте формат входных данных

### Проблемы со Streamlit

1. **Приложение не запускается**:
   - Проверьте, установлены ли все зависимости
   - Убедитесь, что переменная окружения `N8N_BASE_URL` установлена правильно
   - Проверьте логи Streamlit

2. **Ошибка при отправке запроса в n8n**:
   - Убедитесь, что n8n запущен и доступен
   - Проверьте URL вебхука
   - Проверьте формат данных, отправляемых в n8n

### Проблемы с LLM API

1. **Ошибка при отправке запроса в LLM API**:
   - Проверьте API ключ
   - Убедитесь, что у вас достаточно кредитов
   - Проверьте формат запроса

2. **Некорректный ответ от LLM**:
   - Проверьте промпт, отправляемый в LLM
   - Убедитесь, что формат ответа соответствует ожидаемому
   - Попробуйте изменить параметры запроса (temperature, max_tokens)

---

Эта документация предоставляет полное руководство по проекту автоматизации аналитики бизнеса. Она содержит информацию о структуре проекта, рабочих процессах n8n, Streamlit-приложении, настройке и запуске, а также рекомендации по расширению функциональности и развертыванию для клиентов.

Для получения дополнительной информации или помощи обратитесь к разработчику проекта.
